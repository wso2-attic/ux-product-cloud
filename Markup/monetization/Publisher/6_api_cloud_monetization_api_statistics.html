<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WSO2 Cloud</title>

    <!-- Bootstrap -->
    <link href="../../css/bootstrap-3.2.0/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/fontwso2-1.2/css/font-wso2.css">
    <link href="../../css/font-awesome-4.2.0/font-awesome.min.css" rel="stylesheet">
    <link href="../../css/web-fonts/Roboto.css" rel="stylesheet">
    <link href="../../css/datatables-1.10.7/jquery.dataTables.min.css" rel="stylesheet">
    <link href="../../css/datatables-1.10.7/jquery.dataTables.override.css" rel="stylesheet">
    <link href="../../css/select2-4.0.0/select2.min.css" rel="stylesheet">
    <link href="../../css/select2-4.0.0/select2.override.css" rel="stylesheet">
    <link href="../../css/c3/c3.min.css" rel="stylesheet">
    <link href="../../css/styles.css" rel="stylesheet">
    <link href="../../css/daterangepicker/daterangepicker.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- BOF cloud menu -->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="#" id="cloud-menu-popover-xs" data-toggle="popover" data-placement="bottom"
               class="hidden-md hidden-sm hidden-lg cloud-menu-popover">
                <i class="fw fw-tiles"></i>
            </a>
            <a class="navbar-brand" href="#"><img src="../../images/logo.png" alt="wso2-logo" > Cloud</a>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav menu-right">
                <li><a href="#"><i class="fa fa-book"></i> Documentation</a></li>
                <li><a href="#about"><i class="fa fa-envelope"></i> Support</a></li>
                <li class="dropdown user-name">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">jack sparrow
                        <i class="fa fa-chevron-circle-down"></i>
                        <img src="../../images/user.png" alt="user" class="user-image"></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="#">Profile</a></li>
                        <li><a href="#">Logout</a></li>
                    </ul>
                </li>
                <li class="cloud-menu hidden-xs">
                    <a href="#" id="cloud-menu-popover" data-toggle="popover" data-placement="bottom"
                       class="cloud-menu-popover">
                        <i class="fw fw-tiles"></i>
                    </a>
                </li>
            </ul>
            <!-- BOF cloud menu content -->
            <div class="cloud-menu-content hide">
                <div id="popover-head" class="hide">
                    Navigate to Cloud
                </div>
                <div id="popover-content" class="hide">
                    <div class="cloud-apps">
                        <div class="cloud-block cloud-block-default">
                            <div class="cloud-block-invert-icon">
                                <i class="fa fa-2x fa-cubes"><span>Application Cloud</span></i>
                                <div class="cloud-name">Application Cloud</div>
                            </div>
                        </div>
                        <div class="cloud-block cloud-block-default">
                            <div class="cloud-block-invert-icon">
                                <i class="fw fw-2x fw-api"><span>API Cloud</span></i>
                                <div class="cloud-name">API Cloud</div>
                            </div>
                        </div>
                        <div class="cloud-block cloud-block-default">
                            <div class="cloud-block-invert-icon">
                                <i class="fw fw-2x fw-user"><span>User</span></i>
                                <div class="cloud-name">User</div>
                            </div>
                        </div>
                        <div class="clearfix"></div> <!-- to make seperate -->
                    </div>
                    <div class="cloud-actions">
                        <h3>Manage your cloud</h3>
                        <div class="anim-container">
                            <div class="cloud-block-invert cloud-block-invert-sub-true">
                                <div class="back-btn">
                                    <span class="fw-stack fw-lg">
                                        <i class="fw fw-ring fw-stack-2x"></i>
                                        <i class="fw fw-cancel fw-stack-1x"></i>
                                    </span>
                                </div>
                                <div class="cloud-block-invert-icon">
                                    <i class="fa fa-2x fa-institution"><span>Organizations</span></i>
                                    <div class="cloud-name">Organizations</div>
                                </div>
                                <div class="forward-btn">
                                    <i class="fa fa-angle-right"></i>
                                </div>
                                <div class="sub-actions">
                                    <ul class="cloud-block-sub">
                                        <li><a href="#"><i class="fw fw-add-user"></i> Manage User</a></li>
                                        <li><a href="#"><i class="fa fa-users"></i> Member Roles</a></li>
                                        <li><a href="#"><i class="fw fw-mail"></i> Email Templates</a></li>
                                        <li><a href="#"><i class="fw fw-settings"></i> Settings</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="cloud-block-invert cloud-block-invert-sub-true">
                                <div class="back-btn">
                                    <span class="fw-stack fw-lg">
                                        <i class="fw fw-ring fw-stack-2x"></i>
                                        <i class="fw fw-cancel fw-stack-1x"></i>
                                    </span>
                                </div>
                                <div class="cloud-block-invert-icon">
                                    <i class="fa fa-2x fa-users"><span>Members</span></i>
                                    <div class="cloud-name">Members</div>
                                </div>
                                <div class="forward-btn">
                                    <i class="fa fa-angle-right"></i>
                                </div>
                                <div class="sub-actions">

                                    <ul class="cloud-block-sub">
                                        <li><a href="#"><i class="fw fw-user"></i> List item 2.1</a></li>
                                        <li><a href="#"><i class="fw fw-user"></i> List item 2.2</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="cloud-block-invert cloud-block-invert-sub-true">
                                <div class="back-btn">
                                    <span class="fw-stack fw-lg">
                                        <i class="fw fw-ring fw-stack-2x"></i>
                                        <i class="fw fw-cancel fw-stack-1x"></i>
                                    </span>
                                </div>
                                <div class="cloud-block-invert-icon">
                                    <i class="fa fa-2x fa-money"><span>Monetization</span></i>
                                    <div class="cloud-name">Monetization</div>
                                </div>
                                <div class="forward-btn">
                                    <i class="fa fa-angle-right"></i>
                                </div>
                                <div class="sub-actions">
                                    <ul class="cloud-block-sub">
                                        <li><a href="#"><i class="fa fa-usd"></i> List item 2.1</a></li>
                                        <li><a href="#"><i class="fa fa-gbp"></i> List item 2.2</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="cloud-block-invert">
                                <div class="cloud-block-invert-icon">
                                    <i class="fw fw-2x fw-document"><span>Documentation</span></i>
                                    <div class="cloud-name">Documentation</div>
                                </div>
                            </div>
                            <div class="cloud-block-invert cloud-block-invert-sub-true">
                                <div class="back-btn">
                                    <span class="fw-stack fw-lg">
                                        <i class="fw fw-ring fw-stack-2x"></i>
                                        <i class="fw fw-cancel fw-stack-1x"></i>
                                    </span>
                                </div>
                                <div class="cloud-block-invert-icon">
                                    <i class="fa fa-2x fa-cog"><span>Settings</span></i>
                                    <div class="cloud-name">Settings</div>
                                </div>
                                <div class="forward-btn">
                                    <i class="fa fa-angle-right"></i>
                                </div>
                                <div class="sub-actions">

                                    <ul class="cloud-block-sub">
                                        <li><a href="#"><i class="fa fa-plus"></i> List item 2.1</a></li>
                                        <li><a href="#"><i class="fa fa-minus"></i> List item 2.2</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- EOF cloud menu content -->
        </div><!--/.nav-collapse -->
    </div>
</div>
<!-- EOF cloud menu -->
<!-- BOF App factory menu -->
<div class="navbar navbar-secondary">
    <div class="container-fliud">
        <div class="row">
            <div class="side-pane-trigger">
                <i class="fa fa-reorder"></i>
            </div>
            <div class="breadcrumb-secondary">
                <span class="hidden-xs">Monetization </span> / API Cloud / Statistics
            </div>
        </div>
    </div>
</div><!-- EOF App factory menu -->
<div class="inner-wrapper">
    <!-- left pane wrapper -->
    <div class="left-pane">
        <ul>
            <li>
                <a href="009_cloud_app_details_initial.html" target="_blank"><i class="fa fa-laptop"></i> Dashboard</a>
            </li>
            <li>
                <a ><i class="fa fa-cloud"></i> API cloud</a>
                <ul>
                    <li>
                        <a href="team_initial.html"><i class="fa fa-cogs"></i> Plans</a>
                    </li>
                    <li>
                        <a href="team_initial.html"><i class="fa fa-users"></i> Subscribers</a>
                    </li>
                    <li>
                        <a href="team_initial.html"><i class="fa fa-pie-chart"></i> Statistics</a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>

    <!-- left pane wrapper -->
    <div class="right-pane">

        <!-- BOF App factory menu actionbar -->
        <div class="action-bar">
            <a href="009_cloud_app_details_initial.html" class="btn-action">
                <span class="fw-stack fw-lg btn-action-ico">
                    <i class="fw fw-ring fw-stack-2x"></i>
                    <i class="fw fw-left-arrow fw-stack-1x"></i>
                </span> Back to Cloud Selection
            </a>
        </div><!-- EOF App factory menu actionbar-->

        <div class="container-fluid cloud-container">
            <div class="row">
                <div id="margin-top-xs"></div>
                <div class="col-md-12 padding-bottom-xlg">
                    <div class="box profit-comparison">
                        <div class="box-header">
                            <div class="row">
                                <h4 class="margin-left-xs">Profit comparison</h4>
                                <div class="col-lg-2 col-md-2">
                                    <select id="profit-comparison-ds-user-name" class="form-control">
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-2">
                                    <select id="profit-comparison-ds-api-list" class="form-control">
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-2">
                                    <select id="profit-comparison-ds-application" class="form-control">
                                    </select>
                                </div>
                                <div class="pull-right chart-controller">
                                    <div class="btn-toolbar" role="toolbar" aria-label="...">
                                        <div class="btn-group" role="group" aria-label="...">
                                            <button type="button" class="btn btn-week"><p>1 Week</p></button>
                                            <button type="button" class="btn btn-month chart-controller-btn-selected"><p>1 Month</p></button>
                                            <button type="button" class="btn btn-year"><p>1 Year</p></button>
                                            <button type="button" class="btn btn-calender"><span></span><i class="fa fa-calendar fa-2x"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="box-content box-content-padding">
                            <div class="chart-container" id="profit-comparison">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.container -->

    </div>
    <div class="clearfix"></div>
    <div id="push"></div>
</div>
<div id="footer">
    <div class="container-fluid">
        <div class="footer-text">WSO2 Cloud V: 1.2 . &copy; 2015 <i class="fw fw-wso2 fw-2x"></i> All Rights Reserved.</div>
    </div>
</div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="../../js/jquery-1.11.1/jquery.min.js"></script>
<script src="../../js/datatables-1.10.7/jquery.dataTables.min.js"></script>
<script src="../../js/Jeditable-1.7.3/jquery.jeditable.js"></script>
<script src="../../js/datatables-1.10.7/jquery.dataTables.inlineEdit.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../js/datatables-1.10.7/jquery.dataTables.columnFilter.js"></script>
<script src="../../js/bootstrap-3.2.0/bootstrap.min.js"></script>
<script src="../../js/select2-4.0.0/select2.min.js"></script>
<script src="../../js/d3-3.5.3/d3.min.js"></script>
<script src="../../js/daterangepicker-2.0.8/moment.js"></script>
<script src="../../js/daterangepicker-2.0.8/daterangepicker.js"></script>
<script src="../../js/c3/c3.min.js"></script>

<!-- include custom js functions -->
<script src="../../js/custom/custom.js"></script>

<script>

    $('.side-pane-trigger').click(function(){
        var rightPane = $('.right-pane');
        var leftPane = $('.left-pane');
        if (rightPane.hasClass('visible')){
            rightPane.animate({"left":"0em"}, "slow").removeClass('visible');
            leftPane.animate({"left":"-18em"}, "slow");
            $(this).find('i').removeClass('fa-arrow-left').addClass('fa-reorder');
        } else {
            rightPane.animate({"left":"18em"}, "slow").addClass('visible');
            leftPane.animate({"left":"0em"}, "slow");
            $(this).find('i').removeClass('fa-reorder').addClass('fa-arrow-left');
        }
    });

    $('#dashboard-info').DataTable({
        responsive: true,
        "ajax": "../../objects_monetization_dashboard.json",
        "sScrollY" : "135",
        "bFilter" : false,
        "bPaginate" :false,
        "columns": [
            { "data": "user-name", "width": "10%"},
            { "data": "total", "width": "5%"}
        ]
    });

    var userData = [{
        id:0,
        text:"sharon@wso2.com"
    },{
        id:1,
        text: "thusithaya@wso2.com"
    },{
        id:2,
        text: "dakshika@wso2.com"
    },{
        id:2,
        text: "imeshc@wso2.com"
    }];

    var apiData = [{
        id:0,
        text: "API - 1"
    },{
        id:1,
        text: "API - 2"
    },{
        id:2,
        text: "API - 3"
    },{
        id:2,
        text: "API - 4"
    }];

    var applicationData = [{
        id:0,
        text: "Application - 1"
    },{
        id:1,
        text: "Application - 2"
    },{
        id:2,
        text: "Application - 3"
    },{
        id:2,
        text: "Application - 4"
    }]

    /**
     * Select Element for API Usage Users list
     **/
    var apiUsageUserList = $("#api-usage-ds-user-name").select2({
        placeholder:"Search or Select Subscriber",
        data: userData,
        maximumInputLength: 5,
        selectOnBlur: true,
        allowClear: true
    });

    /**
     * Select Element for API Usage API list
     **/
    var apiUsageAPIList = $('#api-usage-ds-api-list').select2({
        placeholder:"Search or Select API",
        maximumInputLength: 5,
        selectOnBlur: true,
    });

    /**
     * Select Element for API Usage Application list
     **/
    var apiUsageApplicationList = $('#api-usage-ds-application').select2({
        placeholder:"Search or Select Application",
        maximumInputLength: 5,
        selectOnBlur: true,
    });

    /**
     * Select Element for Profit Comparison Users list
     **/
    var profitComparisonUserList = $("#profit-comparison-ds-user-name").select2({
        placeholder:"Search or Select Subscriber",
        data: userData,
        maximumInputLength: 5,
        selectOnBlur: true,
        allowClear: true
    });

    /**
     * Select Element for Profit Comparison API list
     **/
    var profitComparisonAPIList = $('#profit-comparison-ds-api-list').select2({
        placeholder:"Search or Select API",
        maximumInputLength: 5,
        selectOnBlur: true,
    });

    /**
     * Select Element for Profit Comparison Application list
     **/
    var profitComparisonApplicationList = $('#profit-comparison-ds-application').select2({
        placeholder:"Search or Select Application",
        maximumInputLength: 5,
        selectOnBlur: true,
    });


    /**
     * Change events for Select 2 elements
     **/
    apiUsageUserList.on("change", function(e){
        apiUsageAPIList.select2({data : apiData});
    });

    apiUsageAPIList.on("change",function(){
        apiUsageApplicationList.select2({data: applicationData})
    });

    profitComparisonUserList.on("change", function(e){
        profitComparisonAPIList.select2({data : apiData});
    });

    profitComparisonAPIList.on("change", function(e){
        profitComparisonApplicationList.select2({data : applicationData});
    });




    /**
     * Intialization of profit comparison chart
     */
    var profitChart = c3.generate({
        bindto: '#profit-comparison',
        data: {
            x: 'x',
            columns: [],
            type: 'bar'
        },
        tooltip: {
            show: false
        },
        bar: {
            width: {
                ratio: 0.4
            }
        },
        padding: {
            top: 20,
            right: 30,
            bottom: 0,
            left: 70,
        },
        axis: {
            x: {
                type: 'category',
                label: {
                    text: 'Month',
                    position: 'outer-middle'
                }
            },
            y: {
                type: 'category',
                label: {
                    text: 'Income',
                    position: 'outer-middle'
                }
            }
        }
    });

    /**
     * Initialization of the API usage chart
     */
    var apiUsageChart = c3.generate({
        bindto: '#api-usage',
        data: {
            x: 'x',
            columns: [],
            type: 'bar'
        },
        tooltip: {
            show: false
        },
        bar: {
            width: {
                ratio: 0.4
            }
        },
        padding: {
            top: 20,
            right: 30,
            bottom: 0,
            left: 70,
        },
        axis: {
            x: {
                type: 'category',
            },
            y: {
                type: 'category',
            }
        }
    });


    $('.profit-comparison .btn-week').click(function(e){
        loadDateToChartObjectForGivenTime([new Date()],'week',profitChart);
        highlightSelected(this);

        addDatesToCurrentAndSet(7,'days')
    });

    $('.profit-comparison .btn-month').click(function(e){
        loadDateToChartObjectForGivenTime([new Date()],'month',profitChart);
        highlightSelected(this);

        addDatesToCurrentAndSet(1,'months')
    });

    $('.profit-comparison .btn-year').click(function(e){
        loadDateToChartObjectForGivenTime([new Date()],'year',profitChart);
        highlightSelected(this);

        addDatesToCurrentAndSet(1,'years')
    });

    function highlightSelected(t){
        var hClass = "chart-controller-btn-selected";
        $(t).addClass(hClass);
        $(t).siblings().removeClass(hClass);
    }

    function addDatesToCurrentAndSet(amount,type){

        $('.btn-calender span').html(moment().subtract(amount,type).format('DD-MM-YYYY')
                                                + ' - ' + moment().format('DD-MM-YYYY'));

        $('.btn-calender').data('daterangepicker').setStartDate(moment().subtract(amount,type));
        $('.btn-calender').data('daterangepicker').setEndDate(moment());
    }

    function cb(start, end) {
        $('.btn-calender span').html(start.format('DD-MM-YYYY') + ' - ' + end.format('DD-MM-YYYY'));
    }
    cb(moment().subtract(29, 'days'), moment());

    $('.btn-calender').daterangepicker({
        "singleDatePicker": false,
        "opens" : "left",
        "startDate": moment().subtract(29, 'days'),
        "endDate": moment()
    }, cb);

    $('.datepicker-container .fw-calendar').click(function(){
        $('.btn-calender').data('daterangepicker').toggle();
    })

    $('.btn-calender').on('apply.daterangepicker', function(ev, picker) {
        var sDate = new Date(picker.startDate.format('YYYY-MM-DD')),
            eDate = new Date(picker.endDate.format('YYYY-MM-DD'));

        loadDateToChartObjectForGivenTime([sDate,eDate],'',profitChart);

        highlightSelected(this);
    });

    loadDateToChartObjectForGivenTime([new Date()],'month',profitChart);

    function loadDateToChartObjectForGivenTime(startDate,numOfDays,chartObj){
        getJsonData('../../objects_monetization_statistics.json',function(response){
            var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            var months = ['January','February','March','April','May','June'
                            ,'July','August','September','October','November','December'];

            var sDate = new Date(Object.keys(response)[0]),
                eDate = new Date(Object.keys(response)[0]);

            if(startDate[0] != undefined){
                sDate = startDate[0];
                eDate = startDate[1];
            }

            switch(numOfDays) {
                case 'week':
                    var endDate = eDate == undefined ? moment(new Date(sDate)).subtract(7, 'days') : eDate;
                    var dates   = ['x'];
                    var value   = ['API'];

                    for(var responseDate in response){
                        if(moment(new Date(responseDate)).isBetween(endDate, sDate)){
                            dates.push(days[new Date(responseDate).getDay()]);
                            value.push(response[responseDate]);
                        }
                    };

                    break;
                case 'month':
                    var endDate = eDate == undefined ? moment(new Date(sDate)).subtract(1, 'months') : eDate;
                    var dates   = ['x'];
                    var value   = ['API'];

                    for(var responseDate in response){
                        if(moment(new Date(responseDate)).isBetween(endDate, sDate)){
                            dates.push(new Date(responseDate).getDate());
                            value.push(response[responseDate]);
                        }
                    }

                    //cb(endDate, sDate);

                    break;
                case 'year':
                    var endDate = eDate == undefined ? moment(new Date(sDate)).subtract(1, 'years') : eDate;
                    var dates   = ['x'];
                    var value   = ['API'];
                    var totalMonthlyAmount = 0;

                    for(var responseDate in response){
                        if(moment(new Date(responseDate)).isBetween(endDate, sDate)){
                            if(isLastDayOfMonth(new Date(responseDate))){
                                dates.push(months[new Date(responseDate).getMonth()]);
                                value.push(totalMonthlyAmount);
                                totalMonthlyAmount = 0;
                            }else if(new Date(responseDate) == endDate){
                                dates.push(months[new Date(responseDate).getMonth()]);
                                value.push(totalMonthlyAmount);
                                totalMonthlyAmount = 0;
                            }
                            totalMonthlyAmount += response[responseDate];
                        }
                    }

                    //cb(endDate.getMonth(), sDate);

                    break;
                default:
                    var dates   = ['x'];
                    var value   = ['API'];

                    for(var responseDate in response){
                        if(moment(new Date(responseDate)).isBetween(sDate , eDate )){
                            dates.push(new Date(responseDate).getDate());
                            value.push(response[responseDate]);
                        }
                    }

                    $('.time-period').text( sDate.getDate() + "/" + sDate.getMonth() + "/"
                            + sDate.getUTCFullYear() + " - " + (eDate.getDate() - 1) + "/" + eDate.getMonth() + "/"
                            + eDate.getUTCFullYear());

                    //cb(endDate.getMonth(), sDate);

                    break;
            }

            chartObj.load({
                columns: [dates,value],
                //unload: chartObj.columns,
            });
            chartObj.transform("bar");
        })
    }

    /**
     *
     * Helper function to add Days to a given date
     *
     * @param days - number of days
     * @returns {Date} - changed date
     */
    Date.prototype.substractDays = function(days)
    {
        var dat = new Date(this.valueOf());
        dat.setDate(dat.getDate() - days);
        return dat;
    }

    function isLastDayOfMonth(dt) {
        var test = new Date(dt.getTime());
        test.setDate(test.getDate() + 1);
        return test.getDate() === 1;
    }

    /**
     *
     * Ajax Wrapper function to load json data
     *
     * @param fileName - This is basically the ajax url
     * @param callback - success callback when the ajax returns
     */
    function getJsonData(fileName,callback){
        $.ajax({
            url : fileName,
            type: 'GET',
            datatype: 'json',
            success: callback
        });
    }

</script>
</body>
</html>